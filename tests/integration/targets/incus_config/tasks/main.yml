- name: Cleanup previous test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
    remote_image: "images:alpine/edge"
  ignore_errors: true


- name: Create a test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote_image: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
    started: true

- name: Set memory limit
  crystian.incus.incus_config:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.memory: "128MiB"
  register: result

- name: Assert memory limit set (changed)
  assert:
    that:
      - result.changed == true

- name: Set memory limit again (idempotency)
  crystian.incus.incus_config:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.memory: "128MiB"
  register: result

- name: Assert memory limit unchanged
  assert:
    that:
      - result.changed == false

- name: Create dummy folder for test (local)
  command: mkdir -p /tmp/incus_test_vol
  when: target_remote is not defined

- name: Create dummy folder for test (remote)
  crystian.incus.incus_exec:
    name: "test-infra-vm"
    command: "mkdir -p /tmp/incus_test_vol"
  when: target_remote is defined

- name: Add disk device
  crystian.incus.incus_config:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    devices:
      testdisk:
        type: disk
        source: /tmp/incus_test_vol
        path: /mnt/test
  register: result

- name: Assert disk added
  assert:
    that:
      - result.changed == true

- name: Unset config
  crystian.incus.incus_config:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    config:
      - limits.memory
  register: result

- name: Assert config unset
  assert:
    that:
      - result.changed == true

- name: Remove device
  crystian.incus.incus_config:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    devices:
      - testdisk
  register: result

- name: Assert device removed
  assert:
    that:
      - result.changed == true

- name: Clean up temporary folder
  file:
    path: /tmp/incus_test_vol
    state: absent
  when: target_remote is not defined

- name: Clean up temporary folder (remote)
  crystian.incus.incus_exec:
    name: "test-infra-vm"
    command: "rm -rf /tmp/incus_test_vol"
  when: target_remote is defined

- name: Remove test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
    remote_image: "images:alpine/edge" # Required by module even for absent
